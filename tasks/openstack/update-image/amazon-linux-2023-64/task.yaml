summary: Update amazon linux 2023 image in openstack account and install test dependencies

systems: [amazon-linux-2023-64-base]

environment:
    TARGET_SYSTEM: amazon-linux-2023-64

execute: |
    . "$TESTSLIB/pkgdb.sh"
    . "$TESTSLIB/utils.sh"

    if [ "$SPREAD_REBOOT" = 0 ]; then
        # Make sure names are resolved (these nameservers are used in aml-2 in ps7)
        echo "nameserver 10.151.11.5" | sudo tee /etc/resolv.conf
        echo "nameserver 10.151.11.7" | sudo tee -a /etc/resolv.conf
        echo "nameserver 10.151.11.7" | sudo tee -a /etc/resolv.conf
        systemctl disable --now systemd-resolved

        # Make the upgrade
        distro_update_package_db
        distro_upgrade_packages
        distro_install_package git
        install_test_dependencies "$TARGET_SYSTEM"        
        remove_pkg_blacklist

        REBOOT
    fi

    # Make sure /etc/environment exists
    touch /etc/environment

    # Setup ntp server depending on the openstack environment
    update_ntp

    # Clean the disk
    clean_machine

restore: |
    # Remove the project path content
    rm -rf "$PROJECT_PATH"
    sync
